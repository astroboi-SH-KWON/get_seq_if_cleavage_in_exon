import time
import os
from Bio import SeqIO

import Util
import Logic
import LogicPrep
############### start to set env ################
WORK_DIR = os.getcwd() + "/"
PROJECT_NAME = WORK_DIR.split("/")[-2]
NCBI = "NCBI/"
genbank_file_name = "Apob_NCBI"

LEN_SPACER = 43
CLEAVAGE = 3
PAM = 'NNGRRT'
LEN_AFTR_PAM = 3
INIT = [LEN_SPACER, CLEAVAGE, PAM, LEN_AFTR_PAM]
############### end setting env #################

"""
[38, 232, 238, 312, 378, 399, 433, 440, 461, 480, 727, 769, 801, 860, 933, 943, 1019, 1027, 1072, 1136, 1191, 1221, 1366, 1413, 1577, 1853, 1939, 1977, 2226, 2270, 2386, 2419, 2612, 2714, 2992, 3025, 3067, 3097, 3107, 3144, 3182, 3356, 3369, 3391, 3451, 3659, 3664, 3682, 3704, 3860, 3956, 4104, 4108, 4194, 4257, 4423, 4446, 4476, 4759, 4795, 4820, 4931, 4966, 5052, 5068, 5079, 5164, 5169, 5176, 5251, 5261, 5355, 5455, 5540, 5556, 5689, 5698, 5756, 5761, 5818, 5878, 6124, 6162, 6194, 6233, 6353, 6385, 6528, 6642, 6662, 6745, 6845, 6868, 6904, 7020, 7062, 7090, 7265, 7340, 7416, 7423, 7456, 7461, 7474, 7515, 7534, 7597, 7627, 7708, 7818, 7839, 7859, 7933, 8040, 8085, 8092, 8162, 8184, 8193, 8204, 8241, 8329, 8358, 8372, 8401, 8461, 8472, 8500, 8566, 8589, 8629, 8708, 8718, 8770, 8790, 8795, 8889, 8914, 8947, 9048, 9057, 9129, 9222, 9252, 9270, 9281, 9366, 9370, 9435, 9467, 9489, 9581, 9615, 9623, 9629, 9701, 9726, 9762, 9782, 9851, 9930, 9934, 9954, 9972, 10111, 10115, 10217, 10390, 10407, 10479, 10646, 10723, 10807, 10883, 10966, 10984, 10991, 11004, 11420, 11434, 11440, 11532, 11569, 11609, 11889, 11959, 12163, 12394, 12749, 12822, 12911, 12989, 13017, 13037, 13105, 13216, 13336, 13379, 13395, 13514, 13648, 13737, 13776, 13813, 13825, 13937, 14118, 14128, 14148, 14154, 14423, 14449, 14481, 14568, 14588, 14625, 14728, 14788, 14880, 14904, 14928, 14938, 14962, 15130, 15136, 15173, 15242, 15247, 15389, 15412, 15448, 15513, 15542, 15811, 15964, 16004, 16019, 16127, 16148, 16633, 16649, 16670, 16694, 16760, 16791, 16899, 17177, 17208, 17216, 17277, 17305, 17320, 17343, 17407, 17412, 17490, 17498, 17579, 17675, 17780, 17869, 17947, 17966, 18084, 18089, 18095, 18130, 18233, 18256, 18309, 18321, 18474, 18498, 18528, 18534, 18559, 18584, 18603, 18665, 18714, 18775, 18794, 18882, 18956, 18982, 19005, 19143, 19155, 19210, 19276, 19331, 19356, 19435, 19485, 19586, 19616, 19680, 19794, 19800, 19829, 19885, 19950, 19972, 20022, 20096, 20115, 20122, 20144, 20306, 20353, 20462, 20545, 20566, 20585, 20611, 20738, 20771, 20885, 20897, 20935, 21081, 21180, 21310, 21449, 21490, 21550, 21571, 21582, 21664, 21713, 21763, 21856, 21877, 21881, 21934, 22112, 22116, 22120, 22128, 22139, 22157, 22245, 22264, 22285, 22398, 22430, 22441, 22455, 22475, 22526, 22573, 22601, 22624, 22631, 22652, 22681, 22702, 23014, 23078, 23086, 23146, 23229, 23309, 23340, 23351, 23657, 23729, 23737, 23762, 23766, 23874, 23968, 23991, 24207, 24296, 24348, 24365, 24452, 24481, 24514, 24534, 24545, 24565, 24573, 24607, 24646, 24692, 24797, 24839, 24897, 24916, 25067, 25129, 25401, 25657, 25684, 25706, 25904, 25938, 26036, 26068, 26086, 26133, 26285, 26363, 26436, 26545, 26666, 26869, 26897, 26950, 26975, 26981, 27040, 27051, 27121, 27154, 27160, 27222, 27277, 27313, 27350, 27430, 27620, 27657, 27696, 27821, 27903, 27934, 27946, 27971, 28046, 28104, 28158, 28437, 28492, 28502, 28649, 28737, 28754, 28761, 28892, 28896, 28901, 29045, 29234, 29351, 29357, 29471, 29478, 29733, 29852, 30036, 30077, 30145, 30177, 30263, 30334, 30496, 30628, 30641, 30661, 30707, 30811, 30851, 30898, 30959, 30972, 31033, 31068, 31089, 31231, 31376, 31435, 31595, 31620, 31744, 31759, 31781, 31815, 31958, 32028, 32088, 32204, 32262, 32316, 32346, 32377, 32390, 32472, 32549, 32649, 32681, 32720, 32776, 32799, 32835, 32847, 33044, 33083, 33104, 33137, 33217, 33221, 33239, 33291, 33314, 33348, 33383, 33440, 33453, 33777, 33803, 33837, 33923, 34047, 34350, 34376, 34395, 34436, 34445, 34685, 34780, 34791, 34798, 34860, 34943, 35059, 35083, 35161, 35303, 35385, 35404, 35446, 35556, 35599, 35620, 35627, 35701, 35846, 35853, 35868, 35900, 36165, 36426, 36432, 36453, 36465, 36489, 36503, 36570, 36809, 36905, 36975, 36989, 37022, 37261, 37335, 37420, 37435, 37567, 37625, 37647, 37658, 37680, 37728, 37742, 37835, 37849, 37933, 38065, 38097, 38147, 38194, 38293, 38329, 38380, 38404, 38478, 38491, 38559, 38569, 38606, 38660, 38721, 38767, 38830, 39117, 39134, 39154]
[16, 61, 120, 320, 335, 396, 515, 627, 636, 677, 878, 949, 967, 1030, 1167, 1192, 1259, 1267, 1292, 1366, 1405, 1442, 1479, 1508, 1538, 1692, 1708, 1809, 1855, 1931, 1998, 2120, 2143, 2264, 2371, 2421, 2462, 2469, 2520, 2546, 2601, 2634, 2696, 2718, 2731, 2815, 2872, 2891, 3090, 3135, 3234, 3331, 3464, 3485, 3692, 3836, 3871, 3960, 4003, 4069, 4082, 4087, 4196, 4213, 4277, 4346, 4475, 4519, 4562, 4821, 4875, 4882, 4892, 4940, 4984, 5008, 5030, 5038, 5247, 5325, 5387, 5479, 5501, 5518, 5582, 5626, 5676, 5686, 5749, 5817, 5906, 5928, 5966, 6096, 6269, 6313, 6360, 6400, 6417, 6440, 6484, 6510, 6541, 6625, 6655, 6700, 6885, 6906, 6931, 6945, 7057, 7103, 7110, 7159, 7172, 7384, 7418, 7698, 7824, 7876, 7957, 7986, 8116, 8197, 8232, 8356, 8521, 8614, 8747, 8811, 8970, 9022, 9113, 9180, 9209, 9217, 9295, 9327, 9492, 9502, 9795, 9834, 9954, 9968, 10022, 10037, 10089, 10132, 10210, 10404, 10461, 10468, 10749, 10833, 10907, 10913, 10979, 10985, 11027, 11187, 11492, 11541, 11638, 11680, 11725, 11813, 11828, 11879, 11912, 12039, 12374, 12385, 12449, 12476, 12530, 12561, 12573, 12591, 12830, 12896, 12937, 13049, 13070, 13085, 13114, 13155, 13237, 13251, 13256, 13268, 13381, 13449, 13509, 13520, 13540, 13546, 13624, 13820, 13833, 13845, 13921, 13946, 13950, 13976, 14128, 14140, 14148, 14173, 14198, 14258, 14308, 14469, 14485, 14632, 14681, 14689, 14817, 14851, 14867, 14882, 14932, 14939, 14953, 14990, 15092, 15131, 15139, 15364, 15372, 15378, 15408, 15509, 15542, 15618, 15624, 15644, 15692, 15830, 15838, 15912, 15927, 15997, 16013, 16022, 16078, 16098, 16167, 16172, 16233, 16249, 16298, 16305, 16312, 16411, 16441, 16461, 16476, 16488, 16493, 16543, 16552, 17022, 17133, 17160, 17188, 17266, 17292, 17317, 17350, 17373, 17423, 17463, 17485, 17491, 17514, 17712, 17727, 17758, 17790, 17819, 17836, 17859, 17875, 17938, 18005, 18026, 18098, 18124, 18149, 18188, 18198, 18235, 18445, 18458, 18509, 18522, 18528, 18554, 18589, 18595, 18717, 18725, 18799, 18803, 18810, 18841, 18848, 18881, 18961, 19018, 19140, 19153, 19184, 19257, 19321, 19362, 19639, 19798, 19803, 19813, 19836, 19992, 20587, 20646, 20661, 20690, 20757, 20846, 20880, 20912, 20994, 21158, 21313, 21408, 21517, 21568, 21574, 21596, 21622, 21638, 21689, 21838, 21946, 22040, 22060, 22071, 22075, 22169, 22204, 22292, 22342, 22381, 22399, 22468, 22475, 22508, 22535, 22554, 22618, 22693, 22766, 22808, 22888, 22909, 22929, 23026, 23045, 23128, 23168, 23253, 23332, 23430, 23476, 23492, 23580, 23721, 23736, 23758, 23770, 23777, 23793, 23885, 23898, 23956, 23982, 24008, 24125, 24132, 24202, 24226, 24242, 24278, 24288, 24293, 24341, 24354, 24365, 24598, 24614, 24636, 24734, 24756, 24799, 24857, 24951, 24981, 24993, 25035, 25164, 25244, 25427, 25497, 25575, 25668, 25692, 25706, 25728, 25764, 25783, 25811, 25865, 25879, 25937, 25964, 25991, 26013, 26019, 26031, 26101, 26165, 26237, 26295, 26326, 26367, 26433, 26484, 26507, 26535, 26621, 26696, 26880, 26951, 26965, 26990, 27000, 27034, 27039, 27088, 27093, 27116, 27200, 27246, 27274, 27327, 27440, 27448, 27540, 27691, 27743, 27820, 27835, 27848, 27891, 27923, 28030, 28039, 28058, 28085, 28118, 28167, 28173, 28359, 28422, 28448, 28482, 28627, 28736, 28767, 28826, 28942, 28989, 29003, 29060, 29193, 29261, 29266, 29320, 29328, 29337, 29456, 29479, 29500, 29550, 29602, 29610, 29683, 29754, 29807, 29836, 29869, 30036, 30045, 30054, 30109, 30126, 30139, 30249, 30363, 30369, 30600, 30695, 30783, 30798, 30905, 30984, 31102, 31113, 31216, 31222, 31261, 31345, 31367, 31407, 31438, 31499, 31538, 31599, 31726, 31887, 31895, 32049, 32129, 32153, 32293, 32336, 32347, 32362, 32384, 32406, 32410, 32418, 32437, 32442, 32458, 32505, 32514, 32559, 32605, 32666, 32698, 32783, 32788, 32854, 32875, 32905, 32991, 32996, 33023, 33042, 33057, 33079, 33102, 33130, 33171, 33191, 33200, 33212, 33225, 33246, 33276, 33291, 33365, 33487, 33501, 33535, 33589, 33594, 33651, 33696, 33749, 33806, 33866, 33886, 33894, 33986, 34028, 34088, 34422, 34582, 34588, 34592, 34596, 34604, 34618, 34629, 34652, 34722, 34747, 34833, 34852, 34971, 35000, 35011, 35063, 35147, 35151, 35169, 35180, 35325, 35386, 35463, 35492, 35559, 35574, 35583, 35637, 35702, 35706, 35717, 35773, 35926, 35970, 36043, 36087, 36285, 36326, 36347, 36390, 36444, 36533, 36622, 36663, 36750, 36759, 36774, 36832, 36880, 36921, 37087, 37117, 37322, 37365, 37380, 37388, 37410, 37435, 37610, 37665, 37695, 37773, 37794, 37855, 37871, 37893, 37964, 38053, 38070, 38163, 38197, 38211, 38429, 38468, 38510, 38557, 38610, 38636, 38676, 38829, 39058, 39080, 39191]
"""
def main():
    for rec in SeqIO.parse(WORK_DIR + NCBI + genbank_file_name, "genbank"):
        if rec.features:
            allfeat = []
            for (item, f) in enumerate(rec.features):
                x = f.__dict__
                q = f.qualifiers
                x.update(q)
                d = {}
                d['start'] = f.location.start
                d['end'] = f.location.end
                d['strand'] = f.location.strand
                print('start : ', d['start'])
                print('end : ', d['end'])




def main1():
    util = Util.Utils()
    logic_prep = LogicPrep.LogicPreps()
    logic = Logic.Logics()

    seq_record = util.get_seq_record_from_genbank(WORK_DIR + NCBI + genbank_file_name + ".gb")
    cds_idx_list = logic_prep.get_cds_idx_arr_to_list(seq_record)
    plus_strand_list, minus_strand_list = logic.get_idx_of_matching_seq(seq_record.seq, PAM)

    plus_idx_list = logic.get_idx_in_list(plus_strand_list, cds_idx_list)
    minus_idx_list = logic.get_idx_in_list(minus_strand_list, cds_idx_list, False)

    filtered_plus_idx_list = logic_prep.filter_out_dupl(plus_idx_list)
    filtered_minus_idx_list = logic_prep.filter_out_dupl(minus_idx_list)

    plus_seq_list = logic.get_trgt_seq_in_idx_list(seq_record.seq, filtered_plus_idx_list, INIT)
    minus_seq_list = logic.get_trgt_seq_in_idx_list(seq_record.seq, filtered_minus_idx_list, INIT, False)

    merge_list = logic_prep.merge_list([plus_seq_list, minus_seq_list])
    tot_list = logic_prep.sort_list_by_ele(merge_list, 0)

    header = ["sequence", "strand"]
    util.make_excel(WORK_DIR + "output/result_" + genbank_file_name, header, tot_list)














if __name__ == '__main__':
    start_time = time.perf_counter()
    print("start [ " + PROJECT_NAME + " ]>>>>>>>>>>>>>>>>>>")
    main1()
    print("::::::::::: %.2f seconds ::::::::::::::" % (time.perf_counter() - start_time))
